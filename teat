local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

local lp = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local Shared = getgenv().SchmecktHubPC or {}
local key = "PlayerPanel"

local IS_MOBILE = Shared.Platform == "Mobile" or UserInputService.TouchEnabled
local SCALE = IS_MOBILE and 0.5 or 1

local function s(v) return math.floor(v * SCALE) end

local CLICK_SOUND_ID = "rbxassetid://100809160609628"
local INTRO_LOGO_ASSET = "rbxassetid://121759217057084"

local clickSound = SoundService:FindFirstChild("SchmecktClickSound")
if not clickSound then
    clickSound = Instance.new("Sound")
    clickSound.Name = "SchmecktClickSound"
    clickSound.SoundId = CLICK_SOUND_ID
    clickSound.Volume = 0.5
    clickSound.Parent = SoundService
end

local function playClick()
    task.spawn(function()
        pcall(function() clickSound:Stop() clickSound:Play() end)
    end)
end

Shared.Connections = Shared.Connections or {}
if Shared.Connections[key] then
    for _, c in pairs(Shared.Connections[key]) do
        if c then pcall(function() c:Disconnect() end) end
    end
end
Shared.Connections[key] = {}

local state = {
    SpeedVal = 50,
    IsNoclip = false,
    IsFly = false,
    IsTPWalk = false
}

local old = CoreGui:FindFirstChild("SchmecktPlayerPanel")
if old then old:Destroy() end

local COL = {
    BgMain = Color3.fromRGB(90, 0, 0),
    BgTop = Color3.fromRGB(140, 0, 0),
    BgInner = Color3.fromRGB(120, 0, 0),
    Card = Color3.fromRGB(135, 0, 0),
    Stroke1 = Color3.fromRGB(255, 110, 110),
    Stroke2 = Color3.fromRGB(255, 150, 150),
    Text = Color3.fromRGB(255, 255, 255),
    DevText = Color3.fromRGB(200, 160, 160),
    SubText = Color3.fromRGB(255, 210, 210),
    ToggleOff = Color3.fromRGB(175, 50, 120),
    ToggleOn = Color3.fromRGB(220, 70, 160),
    InputBg = Color3.fromRGB(110, 0, 0),
    InputFocus = Color3.fromRGB(255, 80, 80),
}

local function corner(inst, px)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, px or s(10))
    c.Parent = inst
    return c
end

local function strokeUI(inst, color, thickness, transparency)
    local st = Instance.new("UIStroke")
    st.Color = color
    st.Thickness = thickness or 1
    st.Transparency = transparency or 0
    st.Parent = inst
    return st
end

local noclipActive = false
local defaultCollisions = setmetatable({}, {__mode = "k"})

local gui = Instance.new("ScreenGui")
gui.Name = "SchmecktPlayerPanel"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = CoreGui

local ROW_H = s(34)
local GAP = s(5)
local headerH = s(50)
local speedRowH = s(38)
local toggleCount = 3
local contentPad = s(10)
local contentInner = speedRowH + GAP + (ROW_H * toggleCount) + (GAP * (toggleCount - 1)) + contentPad * 2
local panelW = s(260)
local panelH = headerH + s(8) + contentInner + s(16)

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, panelW, 0, panelH)
MainFrame.Position = UDim2.new(0, s(20), 0.5, -panelH/2)
MainFrame.BackgroundColor3 = COL.BgMain
MainFrame.BorderSizePixel = 0
MainFrame.Parent = gui
corner(MainFrame, s(14))
strokeUI(MainFrame, COL.Stroke1, s(2), 0)

local HeaderFrame = Instance.new("Frame")
HeaderFrame.Size = UDim2.new(1, -s(14), 0, headerH)
HeaderFrame.Position = UDim2.new(0, s(7), 0, s(7))
HeaderFrame.BackgroundColor3 = COL.BgTop
HeaderFrame.BorderSizePixel = 0
HeaderFrame.Parent = MainFrame
corner(HeaderFrame, s(12))
strokeUI(HeaderFrame, COL.Stroke2, 1, 0.15)

local headerGrad = Instance.new("UIGradient")
headerGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(165, 0, 0)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(120, 0, 0)),
})
headerGrad.Parent = HeaderFrame

local headerLogo = Instance.new("ImageLabel")
headerLogo.Size = UDim2.new(0, s(30), 0, s(30))
headerLogo.Position = UDim2.new(0, s(10), 0.5, -s(15))
headerLogo.BackgroundTransparency = 1
headerLogo.Image = INTRO_LOGO_ASSET
headerLogo.ScaleType = Enum.ScaleType.Crop
headerLogo.ZIndex = 4
headerLogo.Parent = HeaderFrame
corner(headerLogo, s(999))
strokeUI(headerLogo, COL.Stroke2, 1, 0.3)

local headerTitle = Instance.new("TextLabel")
headerTitle.Size = UDim2.new(1, -s(55), 0, s(20))
headerTitle.Position = UDim2.new(0, s(48), 0, s(6))
headerTitle.BackgroundTransparency = 1
headerTitle.Text = "PLAYER PANEL"
headerTitle.Font = Enum.Font.GothamBlack
headerTitle.TextSize = s(12)
headerTitle.TextColor3 = COL.Text
headerTitle.TextXAlignment = Enum.TextXAlignment.Left
headerTitle.ZIndex = 4
headerTitle.Parent = HeaderFrame

local headerSub = Instance.new("TextLabel")
headerSub.Size = UDim2.new(1, -s(55), 0, s(14))
headerSub.Position = UDim2.new(0, s(48), 0, s(28))
headerSub.BackgroundTransparency = 1
headerSub.Text = lp.Name
headerSub.Font = Enum.Font.Gotham
headerSub.TextSize = s(10)
headerSub.TextColor3 = COL.SubText
headerSub.TextXAlignment = Enum.TextXAlignment.Left
headerSub.ZIndex = 4
headerSub.Parent = HeaderFrame

local contentY = headerH + s(14)

local ContentFrame = Instance.new("Frame")
ContentFrame.Size = UDim2.new(1, -s(14), 0, contentInner)
ContentFrame.Position = UDim2.new(0, s(7), 0, contentY)
ContentFrame.BackgroundColor3 = COL.BgInner
ContentFrame.BorderSizePixel = 0
ContentFrame.Parent = MainFrame
corner(ContentFrame, s(12))
strokeUI(ContentFrame, COL.Stroke2, 1, 0.25)

local InnerContainer = Instance.new("Frame")
InnerContainer.Size = UDim2.new(1, -contentPad * 2, 1, -contentPad * 2)
InnerContainer.Position = UDim2.new(0, contentPad, 0, contentPad)
InnerContainer.BackgroundTransparency = 1
InnerContainer.Parent = ContentFrame

local ListLayout = Instance.new("UIListLayout")
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ListLayout.Padding = UDim.new(0, GAP)
ListLayout.Parent = InnerContainer

local SpeedRow = Instance.new("Frame")
SpeedRow.Size = UDim2.new(1, 0, 0, speedRowH)
SpeedRow.BackgroundColor3 = COL.Card
SpeedRow.BorderSizePixel = 0
SpeedRow.LayoutOrder = 0
SpeedRow.Parent = InnerContainer
corner(SpeedRow, s(8))
strokeUI(SpeedRow, COL.Stroke2, 1, 0.4)

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(0.5, -s(10), 1, 0)
SpeedLabel.Position = UDim2.new(0, s(12), 0, 0)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "Speed"
SpeedLabel.Font = Enum.Font.GothamSemibold
SpeedLabel.TextSize = s(12)
SpeedLabel.TextColor3 = COL.Text
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.ZIndex = 5
SpeedLabel.Parent = SpeedRow

local SpeedInput = Instance.new("TextBox")
SpeedInput.Size = UDim2.new(0, s(70), 0, s(26))
SpeedInput.Position = UDim2.new(1, -s(78), 0.5, -s(13))
SpeedInput.BackgroundColor3 = COL.InputBg
SpeedInput.BorderSizePixel = 0
SpeedInput.Font = Enum.Font.GothamSemibold
SpeedInput.TextColor3 = COL.Text
SpeedInput.TextSize = s(12)
SpeedInput.Text = tostring(state.SpeedVal)
SpeedInput.ZIndex = 6
SpeedInput.Parent = SpeedRow
corner(SpeedInput, s(6))
local speedStroke = strokeUI(SpeedInput, COL.Stroke2, 1, 0.4)

SpeedInput.Focused:Connect(function()
    playClick()
    TweenService:Create(speedStroke, TweenInfo.new(0.2), {Color = COL.InputFocus}):Play()
end)

SpeedInput.FocusLost:Connect(function()
    local num = tonumber(SpeedInput.Text)
    if num then
        state.SpeedVal = num
    else
        SpeedInput.Text = tostring(state.SpeedVal)
    end
    TweenService:Create(speedStroke, TweenInfo.new(0.2), {Color = COL.Stroke2}):Play()
end)

local TOGGLE_W = s(60)
local TOGGLE_H = s(24)

local function CreateToggleButton(text, sharedKey, order)
    local Row = Instance.new("Frame")
    Row.Size = UDim2.new(1, 0, 0, ROW_H)
    Row.BackgroundColor3 = COL.Card
    Row.BorderSizePixel = 0
    Row.LayoutOrder = order
    Row.Parent = InnerContainer
    corner(Row, s(8))
    strokeUI(Row, COL.Stroke2, 1, 0.4)

    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1, -(TOGGLE_W + s(24)), 1, 0)
    Label.Position = UDim2.new(0, s(12), 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = text
    Label.Font = Enum.Font.GothamSemibold
    Label.TextSize = s(12)
    Label.TextColor3 = COL.Text
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.ZIndex = 5
    Label.Parent = Row

    local Pill = Instance.new("TextButton")
    Pill.AutoButtonColor = false
    Pill.AnchorPoint = Vector2.new(1, 0.5)
    Pill.Position = UDim2.new(1, -s(8), 0.5, 0)
    Pill.Size = UDim2.new(0, TOGGLE_W, 0, TOGGLE_H)
    Pill.Font = Enum.Font.GothamBold
    Pill.TextSize = s(10)
    Pill.TextColor3 = COL.Text
    Pill.ZIndex = 6
    Pill.Parent = Row
    corner(Pill, s(999))

    local function refresh()
        local on = state[sharedKey]
        Pill.BackgroundColor3 = on and COL.ToggleOn or COL.ToggleOff
        Pill.Text = on and "ON" or "OFF"
    end
    refresh()

    Pill.MouseButton1Click:Connect(function()
        playClick()
        state[sharedKey] = not state[sharedKey]
        refresh()
    end)

    return Row
end

CreateToggleButton("TPWalk", "IsTPWalk", 1)
CreateToggleButton("Noclip", "IsNoclip", 2)
CreateToggleButton("Fly", "IsFly", 3)

local dragging, dragInput, dragStart, startPos
HeaderFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then dragging = false end
        end)
    end
end)
HeaderFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

local FINAL_SIZE = UDim2.new(0, panelW, 0, panelH)
MainFrame.Size = UDim2.new(0, 0, 0, 0)
TweenService:Create(MainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = FINAL_SIZE}):Play()

local function applyNoclipState(char, enabled)
    for _, p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            if enabled then
                if defaultCollisions[p] == nil then defaultCollisions[p] = p.CanCollide end
                p.CanCollide = false
            else
                local def = defaultCollisions[p]
                if def ~= nil then p.CanCollide = def end
            end
        end
    end
end

local lastNoclipCheck = 0
table.insert(Shared.Connections[key], RunService.Stepped:Connect(function(_, dt)
    if not Shared.PlayerPanel then
        gui.Enabled = false
        return
    end
    gui.Enabled = true
    lastNoclipCheck = lastNoclipCheck + dt
    if lastNoclipCheck < 0.1 then return end
    lastNoclipCheck = 0
    local char = lp.Character
    if not char then return end
    if state.IsNoclip or state.IsFly then
        applyNoclipState(char, true)
    else
        applyNoclipState(char, false)
    end
end))

table.insert(Shared.Connections[key], RunService.Heartbeat:Connect(function(dt)
    if not Shared.PlayerPanel then return end
    local char = lp.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not root or not hum then return end
    local camCF = camera.CFrame

    if state.IsFly then
        local moveDir = Vector3.new(0, 0, 0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0, 1, 0) end
        local speed = state.SpeedVal
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then speed = speed * 2 end
        if moveDir.Magnitude > 0 then
            root.CFrame = root.CFrame + (moveDir.Unit * speed * dt)
        end
        root.AssemblyLinearVelocity = Vector3.zero
    elseif state.IsTPWalk then
        hum.PlatformStand = false
        local moveDir = Vector3.new(0, 0, 0)
        local forward = camCF.LookVector * Vector3.new(1, 0, 1)
        local right = camCF.RightVector * Vector3.new(1, 0, 1)
        if forward.Magnitude > 0 then forward = forward.Unit end
        if right.Magnitude > 0 then right = right.Unit end
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + forward end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - forward end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - right end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + right end
        if moveDir.Magnitude > 0 then
            root.CFrame = root.CFrame + (moveDir.Unit * (state.SpeedVal * dt))
            local currentVel = root.AssemblyLinearVelocity
            root.AssemblyLinearVelocity = Vector3.new(0, currentVel.Y, 0)
        end
    else
        hum.PlatformStand = false
    end
end))
