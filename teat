local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local lp = Players.LocalPlayer
local camera = Workspace.CurrentCamera
local Shared = getgenv().SchmecktHubPC or {}
local key = "PlayerPanel"

local SCALE = 1
if Shared.Platform == "Mobile" then
    SCALE = 1 / 2.2
end

local function scaleUDim(x, y)
    return UDim2.new(0, x * SCALE, 0, y * SCALE)
end

local function scaleSize(s)
    return math.floor(s * SCALE)
end

Shared.Connections = Shared.Connections or {}
if Shared.Connections[key] then
    for _, c in pairs(Shared.Connections[key]) do
        if c then pcall(function() c:Disconnect() end) end
    end
end
Shared.Connections[key] = {}

local state = {
    SpeedVal = 50,
    IsNoclip = false,
    IsFly = false,
    IsTPWalk = false
}

local old = CoreGui:FindFirstChild("SchmecktPlayerPanel")
if old then old:Destroy() end

local Theme = {
    Background = Color3.fromRGB(20, 5, 15),
    Card = Color3.fromRGB(45, 12, 35),
    Accent = Color3.fromRGB(255, 20, 147),
    Purple = Color3.fromRGB(180, 50, 255),
    PurpleLight = Color3.fromRGB(220, 130, 255),
    Text = Color3.fromRGB(255, 255, 255),
    SubText = Color3.fromRGB(255, 150, 180),
    Stroke = Color3.fromRGB(150, 30, 100),
}

local LOGO_ASSET = "rbxassetid://121759217057084"
local LOGO2_ASSET = "rbxassetid://118676632373972"

local noclipActive = false
local defaultCollisions = setmetatable({}, {__mode = "k"})

local gui = Instance.new("ScreenGui")
gui.Name = "SchmecktPlayerPanel"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = CoreGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = scaleUDim(250, 210)
MainFrame.Position = UDim2.new(0, 10 * SCALE, 0.5, -(105 * SCALE))
MainFrame.BackgroundColor3 = Theme.Background
MainFrame.BackgroundTransparency = 0.02
MainFrame.BorderSizePixel = 0
MainFrame.Parent = gui
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 14 * SCALE)

local MainStroke = Instance.new("UIStroke")
MainStroke.Thickness = 2 * SCALE
MainStroke.Transparency = 0
MainStroke.Parent = MainFrame

local mainStrokeGrad = Instance.new("UIGradient")
mainStrokeGrad.Rotation = 90
mainStrokeGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 20, 147)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(180, 50, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(220, 20, 60))
})
mainStrokeGrad.Parent = MainStroke

local HeaderFrame = Instance.new("Frame")
HeaderFrame.Name = "Header"
HeaderFrame.Size = UDim2.new(1, 0, 0, 50 * SCALE)
HeaderFrame.BackgroundColor3 = Theme.Card
HeaderFrame.BorderSizePixel = 0
HeaderFrame.Parent = MainFrame
Instance.new("UICorner", HeaderFrame).CornerRadius = UDim.new(0, 14 * SCALE)

local headerGlow = Instance.new("Frame")
headerGlow.Size = UDim2.new(1, 0, 1, 0)
headerGlow.BackgroundColor3 = Theme.Purple
headerGlow.BackgroundTransparency = 0.88
headerGlow.BorderSizePixel = 0
headerGlow.Parent = HeaderFrame
Instance.new("UICorner", headerGlow).CornerRadius = UDim.new(0, 14 * SCALE)

local HeaderLogo1 = Instance.new("ImageLabel")
HeaderLogo1.Size = scaleUDim(28, 28)
HeaderLogo1.Position = UDim2.new(0, 10 * SCALE, 0.5, -(14 * SCALE))
HeaderLogo1.BackgroundColor3 = Theme.Background
HeaderLogo1.Image = LOGO_ASSET
HeaderLogo1.ScaleType = Enum.ScaleType.Crop
HeaderLogo1.Parent = HeaderFrame
Instance.new("UICorner", HeaderLogo1).CornerRadius = UDim.new(0, 6 * SCALE)

local HeaderX = Instance.new("TextLabel")
HeaderX.Size = scaleUDim(14, 28)
HeaderX.Position = UDim2.new(0, 40 * SCALE, 0.5, -(14 * SCALE))
HeaderX.BackgroundTransparency = 1
HeaderX.Text = "X"
HeaderX.Font = Enum.Font.GothamBlack
HeaderX.TextSize = scaleSize(10)
HeaderX.TextColor3 = Theme.Purple
HeaderX.Parent = HeaderFrame

local HeaderLogo2 = Instance.new("ImageLabel")
HeaderLogo2.Size = scaleUDim(24, 24)
HeaderLogo2.Position = UDim2.new(0, 56 * SCALE, 0.5, -(12 * SCALE))
HeaderLogo2.BackgroundTransparency = 1
HeaderLogo2.Image = LOGO2_ASSET
HeaderLogo2.ScaleType = Enum.ScaleType.Fit
HeaderLogo2.Parent = HeaderFrame
Instance.new("UICorner", HeaderLogo2).CornerRadius = UDim.new(1, 0)

local HeaderText = Instance.new("TextLabel")
HeaderText.Size = UDim2.new(1, -(90 * SCALE), 0, 18 * SCALE)
HeaderText.Position = UDim2.new(0, 88 * SCALE, 0, 8 * SCALE)
HeaderText.BackgroundTransparency = 1
HeaderText.Text = "PLAYER PANEL"
HeaderText.Font = Enum.Font.GothamBlack
HeaderText.TextSize = scaleSize(11)
HeaderText.TextColor3 = Theme.Accent
HeaderText.TextXAlignment = Enum.TextXAlignment.Left
HeaderText.Parent = HeaderFrame

local headerTextGrad = Instance.new("UIGradient")
headerTextGrad.Rotation = 0
headerTextGrad.Color = ColorSequence.new({
    ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 20, 147)),
    ColorSequenceKeypoint.new(0.5, Color3.fromRGB(180, 50, 255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 105, 180))
})
headerTextGrad.Parent = HeaderText

local HeaderSub = Instance.new("TextLabel")
HeaderSub.Size = UDim2.new(1, -(90 * SCALE), 0, 14 * SCALE)
HeaderSub.Position = UDim2.new(0, 88 * SCALE, 0, 26 * SCALE)
HeaderSub.BackgroundTransparency = 1
HeaderSub.Text = lp.Name
HeaderSub.Font = Enum.Font.GothamMedium
HeaderSub.TextSize = scaleSize(9)
HeaderSub.TextColor3 = Theme.SubText
HeaderSub.TextXAlignment = Enum.TextXAlignment.Left
HeaderSub.Parent = HeaderFrame

local SpeedSection = Instance.new("Frame")
SpeedSection.Name = "SpeedSection"
SpeedSection.Size = UDim2.new(1, -(16 * SCALE), 0, 32 * SCALE)
SpeedSection.Position = UDim2.new(0, 8 * SCALE, 0, 56 * SCALE)
SpeedSection.BackgroundColor3 = Theme.Card
SpeedSection.BorderSizePixel = 0
SpeedSection.Parent = MainFrame
Instance.new("UICorner", SpeedSection).CornerRadius = UDim.new(0, 8 * SCALE)

local SpeedStroke = Instance.new("UIStroke")
SpeedStroke.Color = Theme.Stroke
SpeedStroke.Thickness = 1.5 * SCALE
SpeedStroke.Transparency = 0.3
SpeedStroke.Parent = SpeedSection

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Size = UDim2.new(0, 50 * SCALE, 1, 0)
SpeedLabel.Position = UDim2.new(0, 12 * SCALE, 0, 0)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "Speed"
SpeedLabel.Font = Enum.Font.GothamBold
SpeedLabel.TextSize = scaleSize(11)
SpeedLabel.TextColor3 = Theme.Text
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.Parent = SpeedSection

local SpeedInput = Instance.new("TextBox")
SpeedInput.Size = scaleUDim(60, 20)
SpeedInput.Position = UDim2.new(1, -(68 * SCALE), 0.5, -(10 * SCALE))
SpeedInput.BackgroundColor3 = Color3.fromRGB(30, 10, 20)
SpeedInput.BorderSizePixel = 0
SpeedInput.Font = Enum.Font.GothamMedium
SpeedInput.TextColor3 = Theme.Text
SpeedInput.TextSize = scaleSize(11)
SpeedInput.Text = tostring(state.SpeedVal)
SpeedInput.Parent = SpeedSection
Instance.new("UICorner", SpeedInput).CornerRadius = UDim.new(0, 6 * SCALE)

SpeedInput.FocusLost:Connect(function()
    local num = tonumber(SpeedInput.Text)
    if num then
        state.SpeedVal = num
    else
        SpeedInput.Text = tostring(state.SpeedVal)
    end
end)

local ButtonContainer = Instance.new("Frame")
ButtonContainer.Name = "ButtonContainer"
ButtonContainer.Size = UDim2.new(1, -(16 * SCALE), 0, 108 * SCALE)
ButtonContainer.Position = UDim2.new(0, 8 * SCALE, 0, 94 * SCALE)
ButtonContainer.BackgroundTransparency = 1
ButtonContainer.Parent = MainFrame

local ListLayout = Instance.new("UIListLayout")
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ListLayout.Padding = UDim.new(0, 6 * SCALE)
ListLayout.Parent = ButtonContainer

local function CreateToggleButton(text, sharedKey)
    local BtnFrame = Instance.new("Frame")
    BtnFrame.Size = UDim2.new(1, 0, 0, 32 * SCALE)
    BtnFrame.BackgroundColor3 = Theme.Card
    BtnFrame.BorderSizePixel = 0
    BtnFrame.Parent = ButtonContainer
    Instance.new("UICorner", BtnFrame).CornerRadius = UDim.new(0, 8 * SCALE)

    local BtnStroke = Instance.new("UIStroke")
    BtnStroke.Color = state[sharedKey] and Theme.Purple or Theme.Stroke
    BtnStroke.Thickness = 1.5 * SCALE
    BtnStroke.Transparency = state[sharedKey] and 0 or 0.3
    BtnStroke.Parent = BtnFrame

    local TextLabel = Instance.new("TextLabel")
    TextLabel.Size = UDim2.new(1, -(55 * SCALE), 1, 0)
    TextLabel.Position = UDim2.new(0, 12 * SCALE, 0, 0)
    TextLabel.BackgroundTransparency = 1
    TextLabel.Text = text
    TextLabel.Font = Enum.Font.GothamBold
    TextLabel.TextSize = scaleSize(11)
    TextLabel.TextColor3 = Theme.Text
    TextLabel.TextXAlignment = Enum.TextXAlignment.Left
    TextLabel.Parent = BtnFrame

    local ToggleBg = Instance.new("Frame")
    ToggleBg.Size = scaleUDim(36, 18)
    ToggleBg.Position = UDim2.new(1, -(44 * SCALE), 0.5, -(9 * SCALE))
    ToggleBg.BackgroundColor3 = state[sharedKey] and Theme.Purple or Color3.fromRGB(40, 20, 30)
    ToggleBg.BorderSizePixel = 0
    ToggleBg.Parent = BtnFrame
    Instance.new("UICorner", ToggleBg).CornerRadius = UDim.new(1, 0)

    local ToggleCircle = Instance.new("Frame")
    ToggleCircle.Size = scaleUDim(14, 14)
    ToggleCircle.Position = state[sharedKey] and UDim2.new(0, 20 * SCALE, 0.5, -(7 * SCALE)) or UDim2.new(0, 2 * SCALE, 0.5, -(7 * SCALE))
    ToggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ToggleCircle.BorderSizePixel = 0
    ToggleCircle.Parent = ToggleBg
    Instance.new("UICorner", ToggleCircle).CornerRadius = UDim.new(1, 0)

    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, 0, 1, 0)
    Button.BackgroundTransparency = 1
    Button.Text = ""
    Button.Parent = BtnFrame

    Button.MouseButton1Click:Connect(function()
        state[sharedKey] = not state[sharedKey]
        local enabled = state[sharedKey]

        TweenService:Create(ToggleCircle, TweenInfo.new(0.2, Enum.EasingStyle.Quart), {
            Position = enabled and UDim2.new(0, 20 * SCALE, 0.5, -(7 * SCALE)) or UDim2.new(0, 2 * SCALE, 0.5, -(7 * SCALE))
        }):Play()
        TweenService:Create(ToggleBg, TweenInfo.new(0.2, Enum.EasingStyle.Quart), {
            BackgroundColor3 = enabled and Theme.Purple or Color3.fromRGB(40, 20, 30)
        }):Play()
        TweenService:Create(BtnStroke, TweenInfo.new(0.2), {
            Color = enabled and Theme.Purple or Theme.Stroke,
            Transparency = enabled and 0 or 0.3
        }):Play()
    end)

    Button.MouseEnter:Connect(function()
        if not state[sharedKey] then
            TweenService:Create(BtnStroke, TweenInfo.new(0.15), {Color = Theme.Purple, Transparency = 0}):Play()
        end
    end)

    Button.MouseLeave:Connect(function()
        if not state[sharedKey] then
            TweenService:Create(BtnStroke, TweenInfo.new(0.15), {Color = Theme.Stroke, Transparency = 0.3}):Play()
        end
    end)

    return BtnFrame
end

CreateToggleButton("TPWalk", "IsTPWalk")
CreateToggleButton("Noclip", "IsNoclip")
CreateToggleButton("Fly", "IsFly")

local mainColorPhase = 0
local mainColorConnection = RunService.Heartbeat:Connect(function(dt)
    if not MainFrame.Parent then
        if mainColorConnection then
            mainColorConnection:Disconnect()
        end
        return
    end
    mainColorPhase = (mainColorPhase + dt * 0.6) % 1
    local function lerpColor(t)
        local colors = {
            Color3.fromRGB(255, 20, 147),
            Color3.fromRGB(220, 20, 60),
            Color3.fromRGB(180, 50, 255),
            Color3.fromRGB(255, 105, 180),
        }
        local index = math.floor(t * #colors) + 1
        local nextIndex = (index % #colors) + 1
        local localT = (t * #colors) % 1
        return colors[index]:Lerp(colors[nextIndex], localT)
    end
    local o1 = mainColorPhase
    local o2 = (mainColorPhase + 0.33) % 1
    local o3 = (mainColorPhase + 0.66) % 1
    mainStrokeGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, lerpColor(o1)),
        ColorSequenceKeypoint.new(0.5, lerpColor(o2)),
        ColorSequenceKeypoint.new(1, lerpColor(o3))
    })
    headerTextGrad.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, lerpColor(o1)),
        ColorSequenceKeypoint.new(0.5, lerpColor(o2)),
        ColorSequenceKeypoint.new(1, lerpColor(o3))
    })
end)
table.insert(Shared.Connections[key], mainColorConnection)

local dragging, dragInput, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end)
MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end)

MainFrame.Size = UDim2.new(0, 0, 0, 0)
TweenService:Create(MainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = scaleUDim(250, 210)}):Play()

local function applyNoclipState(char, enabled)
    for _, p in ipairs(char:GetDescendants()) do
        if p:IsA("BasePart") then
            if enabled then
                if defaultCollisions[p] == nil then defaultCollisions[p] = p.CanCollide end
                p.CanCollide = false
            else
                local def = defaultCollisions[p]
                if def ~= nil then p.CanCollide = def end
            end
        end
    end
end

table.insert(Shared.Connections[key], RunService.Stepped:Connect(function()
    if not Shared.PlayerPanel then
        gui.Enabled = false
        return
    end
    gui.Enabled = true
    local char = lp.Character
    if not char then return end

    if state.IsNoclip or state.IsFly then
        applyNoclipState(char, true)
    else
        applyNoclipState(char, false)
    end
end))

table.insert(Shared.Connections[key], RunService.Heartbeat:Connect(function(dt)
    if not Shared.PlayerPanel then return end
    local char = lp.Character
    if not char then return end
    local root = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChild("Humanoid")
    if not root or not hum then return end
    local camCF = camera.CFrame

    if state.IsFly then
        local moveDir = Vector3.new(0, 0, 0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0, 1, 0) end

        local speed = state.SpeedVal
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then speed = speed * 2 end

        if moveDir.Magnitude > 0 then
            root.CFrame = root.CFrame + (moveDir.Unit * speed * dt)
        end

        root.AssemblyLinearVelocity = Vector3.zero
        
    elseif state.IsTPWalk then
        hum.PlatformStand = false

        local moveDir = Vector3.new(0, 0, 0)
        local forward = camCF.LookVector * Vector3.new(1, 0, 1)
        local right = camCF.RightVector * Vector3.new(1, 0, 1)
        if forward.Magnitude > 0 then forward = forward.Unit end
        if right.Magnitude > 0 then right = right.Unit end

        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + forward end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - forward end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - right end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + right end

        if moveDir.Magnitude > 0 then
            root.CFrame = root.CFrame + (moveDir.Unit * (state.SpeedVal * dt))
            local currentVel = root.AssemblyLinearVelocity
            root.AssemblyLinearVelocity = Vector3.new(0, currentVel.Y, 0)
        end
    else
        hum.PlatformStand = false
    end
end))
